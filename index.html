<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>LiLi影子跟读Pro - 专业语言学习工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="baidu-pan-config.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --dark: #1d3557;
            --light: #f1faee;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e63946;
            --text: #333;
            --subtitle-eng: #FFD700 !important;
            --subtitle-chi: #FFFFFF !important;
            --subtitle-size-base: 1.6rem;
            --subtitle-size-eng: 1.8rem;
            --subtitle-size-chi: 1.0rem;
        }

        #wordTooltip {
            display: none;
            position: fixed;
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.95));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 0;
            max-width: 380px;
            min-width: 280px;
            z-index: 99999;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            animation: tooltipFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        #wordTooltip .word-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        #wordTooltip .word-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
        }
        
        #tooltipWord {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }
        
        #tooltipPhonetic {
            color: #94a3b8;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pronunciation-btn {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: none; /* 默认隐藏，等支持检查后再显示 */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(76, 201, 240, 0.3);
        }
        
        .pronunciation-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.5);
        }
        
        .pronunciation-btn:active {
            transform: scale(0.95);
        }
        
        .pronunciation-btn.playing {
            animation: pulse 0.6s ease-in-out;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        #tooltipDefinition {
            font-size: 1rem;
            line-height: 1.7;
            color: #e2e8f0;
            padding: 20px 24px;
            margin: 0;
            text-align: left;
        }
        
        #tooltipTags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 24px 20px;
            margin: 0;
        }
        
        .word-tag {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: none;
            letter-spacing: 0.025em;
        }
        
        .word-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .word-tag.cet4 {
            background: linear-gradient(to right, #4361ee, #3f37c9);
        }
        
        .word-tag.cet6 {
            background: linear-gradient(to right, #7209b7, #560bad);
        }
        
        .word-tag.ielts {
            background: linear-gradient(to right, #e63946, #d00000);
        }
        
        .word-tag.postgraduate {
            background: linear-gradient(to right, #2ec4b6, #1a936f);
        }
        
        .word-tag.tem4 {
            background: linear-gradient(to right, #ff6b6b, #ee5a52);
        }
        
        .word-tag.tem8 {
            background: linear-gradient(to right, #4ecdc4, #44a08d);
        }
        
        .word-tag.highschool {
            background: linear-gradient(to right, #a8e6cf, #7fcdcd);
        }
        
        .word-tag.junior {
            background: linear-gradient(to right, #ffd93d, #ff6b6b);
        }
        
        .word-tag.toefl {
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
        }
        

        
        .word {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            padding: 1px 2px;
            border-radius: 3px;
            position: relative;
            user-select: none;
            margin: 0 0.5px; /* 缩小单词间距 */
        }
        
        .word:hover {
            background: rgba(76, 201, 240, 0.4);
            transform: translateY(-1px);
            text-shadow: 0 0 8px rgba(76, 201, 240, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .word:active {
            transform: translateY(0px);
            background: rgba(76, 201, 240, 0.6);
        }
        

        
        /* 添加单词高亮效果 */
        .word.highlighted {
            background: rgba(76, 201, 240, 0.6) !important;
            color: #ffffff !important;
            text-shadow: 0 0 10px rgba(76, 201, 240, 1) !important;
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.8) !important;
            transform: scale(1.1) !important;
            z-index: 10;
        }
        

        

        
        /* 移动端单词间距优化 */
        @media (max-width: 768px) {
            .word {
                padding: 0.5px 1px;
                margin: 0 0.3px;
                font-size: 0.95em;
            }
            
            .word.highlighted {
                transform: scale(1.05) !important;
            }
            

            

        }
        
        @media (max-width: 480px) {
            .word {
                padding: 0.5px 0.5px;
                margin: 0 0.2px;
                font-size: 0.9em;
            }
            
            .word.highlighted {
                transform: scale(1.03) !important;
            }
            

            

        }
        
        #wordDbStatus {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(29, 53, 87, 0.9);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--light);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        .subtitle-container {
            pointer-events: auto !important;
        }
        
        .subtitle-container * {
            pointer-events: auto !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2a3c6c, #3a4c6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-attachment: fixed;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(29, 53, 87, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin: 20px auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            padding: 20px;
            text-align: center;
            position: relative;
            border-bottom: 3px solid var(--accent);
        }

        .help-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .help-btn:active {
            transform: translateY(0);
        }

        .help-btn i {
            font-size: 1.1rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            position: relative;
        }

        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
            letter-spacing: 1px;
        }
        
        .copyright {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 3px;
            letter-spacing: 0.5px;
            color: #a8e6cf;
        }

        .main-content {
            padding: 25px;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
        }
        
        /* 确保字幕容器完全在视频区域内 */
        .video-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            pointer-events: none;
            z-index: 5;
        }

        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            border: none;
        }

        .subtitle-container {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            padding: 0 15px;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
            max-height: 35%;
            overflow: visible;
            box-sizing: border-box;
        }

        .subtitle {
            font-size: var(--subtitle-size-base);
            font-weight: 700;
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000,
                0 0 3px rgba(0, 0, 0, 0.8);
            line-height: 1.3;
            margin: 1px 0;
            padding: 3px 8px;
            display: block;
            border-radius: 4px;
            background: transparent;
            transition: all 0.3s ease;
            width: auto;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-height: none;
            overflow: visible;
            white-space: normal;
            text-overflow: clip;
            hyphens: auto;
            -webkit-hyphens: auto;
            -moz-hyphens: auto;
            cursor: pointer;
            box-sizing: border-box;
            text-align: center;
        }
        
        /* 移动端长文本处理 */
        @media (max-width: 768px) {
            .subtitle-container {
                bottom: 8px !important;
                padding: 0 10px !important;
                max-height: 25% !important;
                overflow: visible !important;
                gap: 1px !important;
            }
            
            .subtitle {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                padding: 1px 6px !important;
                line-height: 1.1 !important;
                margin: 0.5px 0 !important;
            }
            
            /* 英文字幕(蓝色)允许换行但尽量保持连贯 */
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 88% !important;
                font-size: 1.3rem !important;
                order: 1 !important;
            }
            
            /* 中文字幕(黄色)允许自由换行 */
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.75rem !important;
                order: 2 !important;
            }
        }

        .english {
            color: var(--subtitle-eng);
            font-size: var(--subtitle-size-eng);
            order: 1 !important;
            flex-shrink: 0;
        }

        .chinese {
            color: var(--subtitle-chi);
            font-size: calc(var(--subtitle-size-chi) + 2px);
            order: 2 !important;
            flex-shrink: 0;
        }

        .controls {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .primary-controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
        }

        .secondary-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 50px;
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-large {
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
        }

        .toggle-btn {
            background: rgba(67, 97, 238, 0.2);
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .toggle-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }
        
        /* 字幕模式选择弹窗 */
        .subtitle-mode-popup {
            position: fixed;
            background: rgba(29, 53, 87, 0.95);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 0;
            max-width: 280px;
            min-width: 240px;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--light);
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
        }
        
        .subtitle-mode-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
        
        .subtitle-mode-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px 0 20px;
            border-bottom: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .subtitle-mode-popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .subtitle-mode-popup-close {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .subtitle-mode-popup-close:hover {
            background: rgba(230, 57, 70, 0.3);
            color: var(--danger);
        }
        
        .subtitle-mode-popup-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .subtitle-mode-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle-mode-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            border-color: var(--accent);
        }
        
        .subtitle-mode-btn.active {
            background: var(--accent);
            color: var(--dark);
            font-weight: 700;
            border-color: var(--accent);
        }
        
        .subtitle-mode-btn i {
            font-size: 1.1rem;
        }

        .counter {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--success);
            color: white;
            border-radius: 20px;
            padding: 8px 15px;
            min-width: 100px;
            text-align: center;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-btn:hover {
            background: rgba(76, 201, 240, 0.3);
        }

        .speed-btn.active {
            background: var(--accent);
            color: var(--dark);
            font-weight: 700;
        }

        .mobile-speed-btn {
            display: none;
            background: rgba(67, 97, 238, 0.2);
            color: var(--accent);
            border: 2px solid var(--accent);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .mobile-speed-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
        }

        .mobile-speed-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .speed-popup {
            position: fixed;
            background: rgba(29, 53, 87, 0.95);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 0;
            max-width: 300px;
            min-width: 250px;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--light);
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .speed-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .speed-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px 0 20px;
            border-bottom: 1px solid rgba(76, 201, 240, 0.3);
        }

        .speed-popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .speed-popup-close {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .speed-popup-close:hover {
            background: rgba(230, 57, 70, 0.3);
            color: var(--danger);
        }

        .speed-popup-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .speed-popup-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
        }

        .speed-popup-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            border-color: var(--accent);
        }

        .speed-popup-btn.active {
            background: var(--accent);
            color: var(--dark);
            font-weight: 700;
            border-color: var(--accent);
        }

        /* 百度网盘集成样式 */
        .baidu-pan-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .baidu-pan-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .baidu-pan-login {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px;
            border-radius: 50px;
            background: linear-gradient(135deg, #2d5aa0, #1e3a8a);
            color: white;
            border: 2px solid #2d5aa0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin: 0 auto;
        }

        .baidu-pan-login:hover {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 90, 160, 0.4);
        }

        .baidu-pan-logout {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 25px;
            background: rgba(230, 57, 70, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .baidu-pan-logout:hover {
            background: rgba(230, 57, 70, 0.3);
            transform: translateY(-1px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d5aa0, #1e3a8a);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 2px;
        }

        .user-space {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .file-browser {
            margin-top: 15px;
        }

        .file-browser-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .file-search {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 0.9rem;
        }

        .file-search::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .file-search-btn {
            padding: 8px 15px;
            background: var(--accent);
            color: var(--dark);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .file-search-btn:hover {
            background: #3ba8c9;
            transform: translateY(-1px);
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
        }

        .file-item:hover {
            background: rgba(76, 201, 240, 0.2);
        }

        .file-item.selected {
            background: rgba(76, 201, 240, 0.3);
            border: 1px solid var(--accent);
        }

        .file-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--light);
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-action-btn {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--light);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .file-action-btn:hover {
            background: var(--accent);
            color: var(--dark);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: var(--accent);
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.4);
        }

        .file-upload {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .upload-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .upload-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 2px solid var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .upload-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--warning);
            min-height: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .status.error {
            color: var(--danger);
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid rgba(230, 57, 70, 0.3);
        }
        
        .status.success {
            color: var(--success);
            background: rgba(46, 196, 182, 0.1);
            border: 1px solid rgba(46, 196, 182, 0.3);
        }
        
        .status.info {
            color: var(--accent);
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--accent));
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* 响应式设计 - 大屏幕 */
        @media (min-width: 1200px) {
            :root {
                --subtitle-size-base: 1.4rem;
                --subtitle-size-eng: 1.9rem;
                --subtitle-size-chi: 1.1rem;
            }
            
            .english {
                font-size: 1.9rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(1.1rem + 2px) !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 85%;
            }
        }

        @media (max-width: 1199px) and (min-width: 769px) {
            :root {
                --subtitle-size-base: 1.3rem;
                --subtitle-size-eng: 1.7rem;
                --subtitle-size-chi: 1.0rem;
            }
            
            .english {
                font-size: 1.7rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(1.0rem + 2px) !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 82%;
            }
        }

        @media (max-width: 768px) {
            :root {
                --subtitle-size-base: 1.0rem;
                --subtitle-size-eng: 1.4rem;
                --subtitle-size-chi: 0.8rem;
            }
            
            .help-btn {
                top: 15px;
                right: 15px;
                padding: 8px 15px;
                font-size: 0.8rem;
            }
            
            .help-btn i {
                font-size: 1rem;
            }
            
            .english {
                font-size: 1.4rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(0.8rem + 1px) !important;
                order: 2 !important;
            }
            
            .container {
                margin: 10px;
            }
            
            .primary-controls {
                gap: 15px;
            }
            
            .secondary-controls {
                gap: 10px;
            }
            
            .btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .btn-large {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .subtitle {
                max-width: 90%;
                padding: 1px 6px;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                line-height: 1.1;
                word-break: break-word;
                overflow-wrap: break-word;
                display: inline-block;
                text-align: center;
            }
            
            .english {
                font-size: 1.3rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.75rem !important;
                order: 2 !important;
            }
            
            .control-group {
                padding: 8px 15px;
            }
            
            .counter {
                font-size: 1rem;
                min-width: 80px;
                padding: 6px 10px;
            }
            
            .speed-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            #wordTooltip {
                max-width: 250px;
                padding: 12px;
            }
            
            #tooltipWord {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            :root {
                --subtitle-size-base: 0.85rem;
                --subtitle-size-eng: 1.15rem;
                --subtitle-size-chi: 0.7rem;
            }
            
            .english {
                font-size: 1.15rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.7rem !important;
                order: 2 !important;
            }
            
            .speed-control {
                display: none;
            }
            
            .mobile-speed-btn {
                display: flex !important;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .primary-controls {
                gap: 8px;
            }
            
            .btn {
                width: 45px;
                height: 45px;
            }
            
            .btn-large {
                width: 55px;
                height: 55px;
            }
            
            .subtitle {
                max-width: 90%;
                padding: 1px 6px;
                line-height: 1.05;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                word-break: break-word;
                overflow-wrap: break-word;
                display: block;
                text-align: center;
                margin: 0.5px 0;
                text-shadow: 
                    -1px -1px 0 #000,  
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000,
                    0 0 2px rgba(0, 0, 0, 0.8);
            }
            
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.65rem !important;
                order: 2 !important;
            }
            
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 88% !important;
                font-size: 1.05rem !important;
                order: 1 !important;
            }
            
            .subtitle-container {
                bottom: 8px !important;
                left: 0 !important;
                right: 0 !important;
                padding: 0 8px !important;
                gap: 0.5px !important;
                max-height: 25% !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
            
            .upload-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            #wordTooltip {
                max-width: 220px;
                padding: 10px;
                font-size: 0.9rem;
            }
            
            #tooltipWord {
                font-size: 1.1rem;
            }
            
            #tooltipDefinition {
                font-size: 0.9rem;
            }
            
            .word-tag {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .pronunciation-btn {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
            }
            
            #tooltipPhonetic {
                font-size: 0.85rem;
                gap: 6px;
            }
        }

        @media (max-width: 360px) {
            :root {
                --subtitle-size-base: 0.75rem;
                --subtitle-size-eng: 1.0rem;
                --subtitle-size-chi: 0.6rem;
            }
            
            .english {
                font-size: 1.0rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.6rem !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 92%;
                padding: 1px 5px;
                line-height: 1.0;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                word-break: break-word;
                overflow-wrap: break-word;
                display: block;
                text-align: center;
                margin: 0.5px 0;
                hyphens: auto;
                text-shadow: 
                    -1px -1px 0 #000,  
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000,
                    0 0 2px rgba(0, 0, 0, 0.8);
            }
            
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 92% !important;
                font-size: 0.55rem !important;
                order: 2 !important;
            }
            
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.9rem !important;
                order: 1 !important;
            }
            
            .subtitle-container {
                bottom: 6px !important;
                left: 0 !important;
                right: 0 !important;
                gap: 0.5px !important;
                padding: 0 6px !important;
                max-height: 25% !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
            
            .pronunciation-btn {
                width: 22px;
                height: 22px;
                font-size: 0.65rem;
            }
            
            #tooltipPhonetic {
                font-size: 0.8rem;
                gap: 5px;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .btn-active {
            animation: pulse 0.5s ease;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a3c6c, #3a4c6c);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-family: 'Roboto', sans-serif;
        }
        
        .page-loading.hidden {
            display: none;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--accent);
        }
    </style>
</head>
<body>
            <div class="page-loading" id="pageLoading">
            <div class="loading"></div>
            <div class="loading-text">LiLi影子跟读Pro 正在加载...</div>
        </div>
    
    <div id="wordTooltip">
        <div class="word-header">
            <div id="tooltipWord">Word</div>
            <div id="tooltipPhonetic">
                <span id="tooltipPhoneticText">/prəˌnʌnsiˈeɪʃən/</span>
                <button class="pronunciation-btn" id="pronunciationBtn" title="播放美式发音">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
        <div id="tooltipDefinition">Definition will appear here.</div>
        <div id="tooltipTags"></div>
    </div>
    
    <div id="wordDbStatus">
        <span class="loading"></span> 加载单词数据库中...
    </div>
    
    <div class="speed-popup" id="speedPopup">
        <div class="speed-popup-header">
            <div class="speed-popup-title">选择播放速度</div>
            <button class="speed-popup-close" id="speedPopupClose">&times;</button>
        </div>
        <div class="speed-popup-content">
            <button class="speed-popup-btn" data-speed="0.25">0.25x</button>
            <button class="speed-popup-btn" data-speed="0.5">0.5x</button>
            <button class="speed-popup-btn" data-speed="0.75">0.75x</button>
            <button class="speed-popup-btn active" data-speed="1">1x</button>
            <button class="speed-popup-btn" data-speed="1.25">1.25x</button>
        </div>
    </div>
    
    <div class="subtitle-mode-popup" id="subtitleModePopup">
        <div class="subtitle-mode-popup-header">
            <div class="subtitle-mode-popup-title">选择字幕模式</div>
            <button class="subtitle-mode-popup-close" id="subtitleModePopupClose">&times;</button>
        </div>
        <div class="subtitle-mode-popup-content">
            <button class="subtitle-mode-btn active" data-mode="both">
                <i class="fas fa-closed-captioning"></i>
                中英双语
            </button>
            <button class="subtitle-mode-btn" data-mode="english">
                <i class="fas fa-font"></i>
                仅英文
            </button>
            <button class="subtitle-mode-btn" data-mode="chinese">
                <i class="fas fa-language"></i>
                仅中文
            </button>
            <button class="subtitle-mode-btn" data-mode="none">
                <i class="fas fa-eye-slash"></i>
                无字幕
            </button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>LiLi影子跟读Pro</h1>
            <div class="tagline">专业级语言学习工具 - 提升口语流利度</div>
            <div class="copyright">李李学英语独自开发，侵权必究</div>
            <button class="help-btn" id="helpBtn" title="使用说明">
                <i class="fas fa-question-circle"></i>
                使用说明
            </button>
        </header>
        
        <div class="main-content">
            <div class="video-container">
                <video class="video-player" id="videoPlayer" playsinline>
                    您的浏览器不支持视频播放
                </video>
                
                <div class="subtitle-container" id="subtitleContainer">
                    <div class="subtitle english" id="englishSub" style="order: 1 !important;"></div>
                    <div class="subtitle chinese" id="chineseSub" style="order: 2 !important;"></div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="controls">
                <div class="primary-controls">
                    <button class="btn" id="prevBtn" title="上一句">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="btn btn-large" id="playPauseBtn" title="播放/暂停">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn" id="nextBtn" title="下一句">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="secondary-controls">
                    <div class="control-group">
                        <button class="btn toggle-btn" id="loopBtn" title="单句循环">
                            <i class="fas fa-repeat"></i>
                        </button>
                        <div class="counter" id="loopCounter">循环: 0</div>
                    </div>
                    
                    <div class="control-group">
                        <button class="btn toggle-btn" id="subtitleBtn" title="字幕模式选择">
                            <i class="fas fa-closed-captioning"></i>
                        </button>
                        <div id="subtitleModeText">中英双语</div>
                    </div>
                    
                    <div class="control-group">
                        <div>倍速:</div>
                        <div class="speed-control">
                            <button class="speed-btn" data-speed="0.25">0.25x</button>
                            <button class="speed-btn" data-speed="0.5">0.5x</button>
                            <button class="speed-btn" data-speed="0.75">0.75x</button>
                            <button class="speed-btn active" data-speed="1">1x</button>
                            <button class="speed-btn" data-speed="1.25">1.25x</button>
                        </div>
                        <button class="mobile-speed-btn" id="mobileSpeedBtn" title="选择倍速">
                            <i class="fas fa-tachometer-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="baidu-pan-container">
                <div class="baidu-pan-title">百度网盘学习材料</div>
                
                <!-- 登录状态 -->
                <div id="loginSection" style="display: none;">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">用户名</div>
                            <div class="user-space" id="userSpace">空间信息</div>
                        </div>
                        <button class="baidu-pan-logout" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </button>
                    </div>
                    
                    <!-- 文件浏览器 -->
                    <div class="file-browser">
                        <div class="breadcrumb" id="breadcrumb">
                            <span class="breadcrumb-item" data-path="/">根目录</span>
                        </div>
                        
                        <div class="file-browser-header">
                            <input type="text" class="file-search" id="fileSearch" placeholder="搜索文件...">
                            <button class="file-search-btn" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        
                        <div class="file-list" id="fileList">
                            <!-- 文件列表将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 未登录状态 -->
                <div id="logoutSection">
                    <button class="baidu-pan-login" id="loginBtn">
                        <i class="fab fa-baidu"></i> 登录百度网盘
                    </button>
                    <div class="status" id="statusMessage">请登录百度网盘账号以访问您的学习材料</div>
                </div>
                
                <!-- 已选择文件信息 -->
                <div class="preview-container" id="previewContainer" style="display: none;">
                    <div class="preview-title">已选择文件</div>
                    <div class="preview-filename" id="videoFilename">未选择视频文件</div>
                    <div class="preview-filename" id="subtitleFilename">未选择字幕文件</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 单词数据库（从外部JSON文件加载）
        let wordDatabase = {};
        let wordDatabaseLoaded = false;
        

        

        
        // 语音合成相关变量
        let speechSynthesis = window.speechSynthesis || null;
        let currentUtterance = null;
        let currentWord = '';
        
        // 检查浏览器是否支持语音合成
        const isSpeechSynthesisSupported = () => {
            return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
        };
        
        // 初始化单词数据库
        function initWordDatabase() {
            console.log('正在从外部文件加载单词数据库...');
            const wordDbStatus = document.getElementById('wordDbStatus');
            
            // 从外部JSON文件加载单词数据库
            fetch('word_translation.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('外部单词数据库加载成功');
                    
                    // 将外部JSON数据转换为内部格式
                    if (Array.isArray(data)) {
                        // 处理数组格式的单词数据
                        data.forEach(wordItem => {
                            if (wordItem.word) {
                                const word = wordItem.word.toLowerCase();
                                
                                // 提取音标和释义
                                let phonetic = "";
                                if (wordItem.ukphone) {
                                    phonetic = `[英] ${wordItem.ukphone}`;
                                    if (wordItem.usphone) {
                                        phonetic += ` [美] ${wordItem.usphone}`;
                                    }
                                } else if (wordItem.usphone) {
                                    phonetic = `[美] ${wordItem.usphone}`;
                                } else if (wordItem.phonetic) {
                                    phonetic = wordItem.phonetic;
                                }
                                let definition = wordItem.translation || "";
                                

                                
                                // 转换difficulty为tags
                                const tags = [];
                                if (wordItem.difficulty) {
                                    wordItem.difficulty.forEach(diff => {
                                        // 直接使用原始难度名称，让tagConfig来处理映射
                                        tags.push(diff);
                                    });
                                }
                                
                                wordDatabase[word] = {
                                    phonetic: phonetic,
                                    definition: definition,
                                    tags: tags
                                };
                            }
                        });
                    } else {
                        console.error('外部单词数据库格式不正确');
                        throw new Error('单词数据库格式不正确');
                    }
                    
                    wordDatabaseLoaded = true;
                    console.log('单词数据库转换完成，包含 ' + Object.keys(wordDatabase).length + ' 个单词');
                wordDbStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #2ec4b6;"></i> 单词数据库已加载';
                    
                    // 如果字幕已经加载，重新调用updateSubtitles
                    if (typeof updateSubtitles === 'function' && subtitles && subtitles.length > 0) {
                        updateSubtitles();
                    }
                
                // 3秒后隐藏状态提示
                setTimeout(() => {
                    wordDbStatus.style.opacity = '0';
                    setTimeout(() => {
                        wordDbStatus.style.display = 'none';
                    }, 500);
                }, 3000);
                })
                .catch(error => {
                    console.error('加载外部单词数据库失败:', error);
                    wordDbStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ff9f1c;"></i> 单词数据库加载失败';
                    
                    // 3秒后隐藏状态提示
                    setTimeout(() => {
                        wordDbStatus.style.opacity = '0';
                        setTimeout(() => {
                            wordDbStatus.style.display = 'none';
                        }, 500);
                    }, 3000);
                });
        }
        

        
        // 全局变量，确保事件只绑定一次
        let wordClickEventBound = false;
        
        // 语音合成功能
        function speakWord(word) {
            // 检查浏览器是否支持语音合成
            if (!isSpeechSynthesisSupported() || !speechSynthesis) {
                console.warn('浏览器不支持语音合成功能');
                return;
            }
            
            // 停止当前播放
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            
            // 创建新的语音合成实例
            currentUtterance = new SpeechSynthesisUtterance(word);
            currentWord = word;
            
            // 设置语音参数 - 美式发音
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = 0.8; // 稍慢一些，便于学习
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;
            
            // 尝试选择美式英语女声
            const voices = speechSynthesis.getVoices();
            const usVoice = voices.find(voice => 
                voice.lang === 'en-US' && 
                (voice.name.includes('Samantha') || voice.name.includes('Karen') || voice.name.includes('Alex'))
            );
            
            if (usVoice) {
                currentUtterance.voice = usVoice;
            }
            
            // 播放开始事件
            currentUtterance.onstart = function() {
                const btn = document.getElementById('pronunciationBtn');
                if (btn) {
                    btn.classList.add('playing');
                    btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
            };
            
            // 播放结束事件
            currentUtterance.onend = function() {
                const btn = document.getElementById('pronunciationBtn');
                if (btn) {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                currentUtterance = null;
            };
            
            // 播放错误事件
            currentUtterance.onerror = function(event) {
                console.error('语音播放错误:', event);
                const btn = document.getElementById('pronunciationBtn');
                if (btn) {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                currentUtterance = null;
            };
            
            // 开始播放
            speechSynthesis.speak(currentUtterance);
        }
        
        // 停止语音播放
        function stopSpeaking() {
            if (currentUtterance && speechSynthesis) {
                speechSynthesis.cancel();
                currentUtterance = null;
                
                const btn = document.getElementById('pronunciationBtn');
                if (btn) {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
            }
        }
        
        // 添加单词点击支持
        function addWordClickSupport() {
            if (wordClickEventBound) return;
            wordClickEventBound = true;
            
            // 使用事件委托，绑定到document
            document.addEventListener('click', function(e) {
                // 检查是否点击了单词元素
                if (e.target.classList.contains('word')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const word = e.target.getAttribute('data-word');
                    if (word) {
                        // 移除之前的高亮
                        document.querySelectorAll('.word.highlighted').forEach(el => {
                            el.classList.remove('highlighted');
                        });
                        
                        // 添加高亮效果
                        e.target.classList.add('highlighted');
                        
                        // 显示工具提示
                        showWordTooltip(word, e.clientX, e.clientY);
                        
                        // 3秒后自动移除高亮
                        setTimeout(() => {
                            e.target.classList.remove('highlighted');
                        }, 3000);
                    }
                    return;
                }
                
                // 点击其他地方隐藏工具提示和移除高亮
                const tooltip = document.getElementById('wordTooltip');
                if (tooltip && !e.target.closest('#wordTooltip')) {
                    tooltip.style.display = 'none';
                    // 移除所有高亮
                    document.querySelectorAll('.word.highlighted').forEach(el => {
                        el.classList.remove('highlighted');
                    });
                    // 停止语音播放
                    stopSpeaking();
                }
            });
        }
        
        // 词形还原函数
        function getBaseForm(word) {
            const lowerWord = word.toLowerCase();
            
            // 常见动词时态变化规则
            const verbEndings = [
                // 过去式和过去分词
                {suffix: 'ed', base: ''},
                {suffix: 'ied', base: 'y'},
                {suffix: 'd', base: ''},
                // 现在分词
                {suffix: 'ing', base: ''},
                {suffix: 'ying', base: 'ie'},
                // 第三人称单数
                {suffix: 's', base: ''},
                {suffix: 'es', base: ''},
                {suffix: 'ies', base: 'y'},
                // 比较级和最高级
                {suffix: 'er', base: ''},
                {suffix: 'est', base: ''},
                {suffix: 'ier', base: 'y'},
                {suffix: 'iest', base: 'y'},
                // 名词复数
                {suffix: 'ies', base: 'y'},
                {suffix: 'ves', base: 'f'},
                {suffix: 's', base: ''},
                {suffix: 'es', base: ''}
            ];
            
            // 特殊不规则动词变化
            const irregularVerbs = {
                'teased': 'tease',
                'teasing': 'tease',
                'teases': 'tease',
                'went': 'go',
                'gone': 'go',
                'going': 'go',
                'goes': 'go',
                'went': 'go',
                'saw': 'see',
                'seen': 'see',
                'seeing': 'see',
                'sees': 'see',
                'came': 'come',
                'coming': 'come',
                'comes': 'come',
                'did': 'do',
                'done': 'do',
                'doing': 'do',
                'does': 'do',
                'had': 'have',
                'having': 'have',
                'has': 'have',
                'was': 'be',
                'were': 'be',
                'been': 'be',
                'being': 'be',
                'am': 'be',
                'is': 'be',
                'are': 'be'
            };
            
            // 检查不规则动词
            if (irregularVerbs[lowerWord]) {
                return irregularVerbs[lowerWord];
            }
            
            // 尝试词形还原
            for (const ending of verbEndings) {
                if (lowerWord.endsWith(ending.suffix)) {
                    const baseForm = lowerWord.slice(0, -ending.suffix.length) + ending.base;
                    if (wordDatabase[baseForm]) {
                        return baseForm;
                    }
                }
            }
            
            return lowerWord;
        }
        
        // 获取时态信息
        function getTenseInfo(word, baseForm) {
            const lowerWord = word.toLowerCase();
            
            if (lowerWord.endsWith('ed')) {
                return `[${baseForm}的过去式/过去分词]`;
            } else if (lowerWord.endsWith('ing')) {
                return `[${baseForm}的现在分词/动名词]`;
            } else if (lowerWord.endsWith('s') && !lowerWord.endsWith('ss')) {
                return `[${baseForm}的第三人称单数]`;
            } else if (lowerWord.endsWith('er')) {
                return `[${baseForm}的比较级]`;
            } else if (lowerWord.endsWith('est')) {
                return `[${baseForm}的最高级]`;
            } else if (lowerWord.endsWith('ies')) {
                return `[${baseForm}的复数形式]`;
            } else if (lowerWord.endsWith('s')) {
                return `[${baseForm}的复数形式]`;
            }
            
            return '';
        }
        
        // 显示单词工具提示
        function showWordTooltip(word, x, y) {
            const tooltip = document.getElementById('wordTooltip');
            if (!tooltip) return;
            
            // 检查单词数据库是否已加载
            if (!wordDatabaseLoaded) {
                const wordDbStatus = document.getElementById('wordDbStatus');
                if (wordDbStatus) {
                    wordDbStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 单词数据库正在加载中...';
                    wordDbStatus.style.display = 'flex';
                    wordDbStatus.style.opacity = '1';
                }
                return;
            }
            
            // 尝试词形还原
            const baseForm = getBaseForm(word);
            let wordData = wordDatabase[word.toLowerCase()];
            
            if (!wordData && baseForm !== word.toLowerCase()) {
                wordData = wordDatabase[baseForm];
                if (wordData) {
                    // 如果找到了原型，在释义前添加时态说明
                    const tenseInfo = getTenseInfo(word, baseForm);
                    wordData = {
                        ...wordData,
                        definition: `${tenseInfo} ${wordData.definition}`
                    };
                }
            }
            
            if (!wordData) {
                wordData = {
                    definition: "未找到该单词的释义",
                    phonetic: "",
                    tags: []
                };
            }
            
            // 设置内容
            document.getElementById('tooltipWord').textContent = word;
            document.getElementById('tooltipPhoneticText').textContent = wordData.phonetic || "";
            document.getElementById('tooltipDefinition').textContent = wordData.definition;
            
            // 设置发音按钮事件
            const pronunciationBtn = document.getElementById('pronunciationBtn');
            if (pronunciationBtn) {
                // 检查是否支持语音合成
                if (isSpeechSynthesisSupported()) {
                    // 移除之前的事件监听器
                    pronunciationBtn.replaceWith(pronunciationBtn.cloneNode(true));
                    const newPronunciationBtn = document.getElementById('pronunciationBtn');
                    
                    // 添加新的事件监听器
                    newPronunciationBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (currentUtterance && currentWord === word) {
                            // 如果正在播放同一个单词，则停止播放
                            stopSpeaking();
                        } else {
                            // 播放单词发音
                            speakWord(word);
                        }
                    });
                    
                    // 显示发音按钮
                    newPronunciationBtn.style.display = 'flex';
                } else {
                    // 隐藏发音按钮
                    pronunciationBtn.style.display = 'none';
                }
            }
            
            // 设置标签
            const tagsContainer = document.getElementById('tooltipTags');
            tagsContainer.innerHTML = '';
            
            const tagConfig = {
                "cet4": {text: "四级", class: "cet4"},
                "cet6": {text: "六级", class: "cet6"},
                "ielts": {text: "雅思", class: "ielts"},
                "postgraduate": {text: "考研", class: "postgraduate"},
                "tem4": {text: "专四", class: "tem4"},
                "tem8": {text: "专八", class: "tem8"},
                "highschool": {text: "高中", class: "highschool"},
                "junior": {text: "初中", class: "junior"},
                "toefl": {text: "托福", class: "toefl"},
                "专四核心词汇": {text: "专四", class: "tem4"},
                "专八核心词汇": {text: "专八", class: "tem8"},
                "高中词汇": {text: "高中", class: "highschool"},
                "初中词汇": {text: "初中", class: "junior"},
                "考研词汇": {text: "考研", class: "postgraduate"},
                "雅思词汇": {text: "雅思", class: "ielts"},
                "托福词汇": {text: "托福", class: "toefl"},

            };
            
            wordData.tags.forEach(tag => {
                if (tagConfig[tag]) {
                    const tagEl = document.createElement('div');
                    tagEl.textContent = tagConfig[tag].text;
                    tagEl.className = `word-tag ${tagConfig[tag].class}`;
                    tagsContainer.appendChild(tagEl);
                }
            });
            
            // 显示工具提示
            tooltip.style.display = 'block';
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            
            // 计算位置
            setTimeout(() => {
                const rect = tooltip.getBoundingClientRect();
                let left = x - rect.width / 2;
                let top = y - rect.height - 10;
                
                // 边界检查
                if (left < 10) left = 10;
                if (left + rect.width > window.innerWidth - 10) {
                    left = window.innerWidth - rect.width - 10;
                }
                if (top < 10) top = y + 20;
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }, 0);
        }
        
        // 渲染英文句子（拆分单词）
        function renderEnglishSentence(sentence) {
            return sentence.split(/([ ,.!?;:])/).filter(Boolean).map(token => {
                if (/^[,.!?;:\s]+$/.test(token)) {
                    return token;
                }
                const word = token.replace(/[^a-zA-Z'-]/g, '');
                if (word.length > 0) {
                    return `<span class="word" data-word="${word}">${token}</span>`;
                } else {
                    return token;
                }
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('LiLi影子跟读Pro - DOM加载完成');
            
            // 立即绑定单词点击事件
            addWordClickSupport();
            
            // 初始化单词数据库
            initWordDatabase();
            

            

            
            // 获取DOM元素
            const videoPlayer = document.getElementById('videoPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const loopBtn = document.getElementById('loopBtn');
            const subtitleBtn = document.getElementById('subtitleBtn');
            const loopCounter = document.getElementById('loopCounter');
            const subtitleContainer = document.getElementById('subtitleContainer');
            const englishSub = document.getElementById('englishSub');
            const chineseSub = document.getElementById('chineseSub');
            const statusMessage = document.getElementById('statusMessage');
            const speedBtns = document.querySelectorAll('.speed-btn');
            const mobileSpeedBtn = document.getElementById('mobileSpeedBtn');
            const speedPopup = document.getElementById('speedPopup');
            const speedPopupClose = document.getElementById('speedPopupClose');
            const speedPopupBtns = document.querySelectorAll('.speed-popup-btn');
            const subtitleModePopup = document.getElementById('subtitleModePopup');
            const subtitleModePopupClose = document.getElementById('subtitleModePopupClose');
            const subtitleModeBtns = document.querySelectorAll('.subtitle-mode-btn');
            const subtitleModeText = document.getElementById('subtitleModeText');
            const progressBar = document.getElementById('progressBar');
            const helpBtn = document.getElementById('helpBtn');
            
            // 百度网盘相关元素
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginSection = document.getElementById('loginSection');
            const logoutSection = document.getElementById('logoutSection');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userSpace = document.getElementById('userSpace');
            const fileSearch = document.getElementById('fileSearch');
            const searchBtn = document.getElementById('searchBtn');
            const fileList = document.getElementById('fileList');
            const breadcrumb = document.getElementById('breadcrumb');
            const previewContainer = document.getElementById('previewContainer');
            const videoFilename = document.getElementById('videoFilename');
            const subtitleFilename = document.getElementById('subtitleFilename');
            
            // 字幕数据
            let subtitles = [];
            let currentSubIndex = 0;
            let loopCount = 0;
            let isLooping = false;
            let subtitleMode = 'both'; // 'both', 'english', 'chinese', 'none'
            let currentLoopStart = 0;
            let currentLoopEnd = 0;
            
            // 百度网盘相关变量
            let baiduPanAPI = null;
            let currentPath = '/';
            let selectedVideoFile = null;
            let selectedSubtitleFile = null;
            let currentFileList = [];
            
            // 初始化页面
            function initializePage() {
                console.log('开始初始化页面...');
                
                // 初始化百度网盘API
                baiduPanAPI = new BaiduPanAPI();
                
                // 检查是否已登录百度网盘
                if (baiduPanAPI.isLoggedIn()) {
                    showLoginSection();
                    loadUserInfo();
                    loadFileList();
                } else {
                    showLogoutSection();
                }
                
                // 初始化字幕显示
                updateSubtitles();
                
                // 初始化语音合成
                if (isSpeechSynthesisSupported() && speechSynthesis) {
                    // 等待语音列表加载完成
                    speechSynthesis.onvoiceschanged = function() {
                        console.log('语音合成功能已初始化');
                    };
                    
                    // 如果语音列表已经可用，直接初始化
                    if (speechSynthesis.getVoices().length > 0) {
                        console.log('语音合成功能已初始化');
                    }
                } else {
                    console.warn('浏览器不支持语音合成功能');
                }
                
                // 添加错误处理
                videoPlayer.addEventListener('error', function(e) {
                    console.error('视频加载错误:', e);
                    statusMessage.textContent = "视频加载失败，请重新选择文件";
                });
                
                console.log('页面初始化完成');
                
                // 隐藏加载指示器
                const pageLoading = document.getElementById('pageLoading');
                if (pageLoading) {
                    pageLoading.classList.add('hidden');
                }
            }
            
            // 百度网盘相关函数
            function showLoginSection() {
                loginSection.style.display = 'block';
                logoutSection.style.display = 'none';
            }
            
            function showLogoutSection() {
                loginSection.style.display = 'none';
                logoutSection.style.display = 'block';
            }
            
            async function loadUserInfo() {
                try {
                    const userInfo = await baiduPanAPI.getUserInfo();
                    userName.textContent = userInfo.baidu_name || '百度用户';
                    userAvatar.textContent = (userInfo.baidu_name || 'U').charAt(0).toUpperCase();
                    
                    // 格式化空间信息
                    const usedSpace = formatFileSize(userInfo.used);
                    const totalSpace = formatFileSize(userInfo.total);
                    userSpace.textContent = `已使用 ${usedSpace} / ${totalSpace}`;
                } catch (error) {
                    console.error('加载用户信息失败:', error);
                    statusMessage.textContent = "加载用户信息失败";
                }
            }
            
            async function loadFileList(path = '/') {
                try {
                    statusMessage.innerHTML = '<span class="loading"></span> 正在加载文件列表...';
                    currentPath = path;
                    
                    const fileListData = await baiduPanAPI.getFileList(path);
                    currentFileList = fileListData.list || [];
                    
                    renderFileList(currentFileList);
                    updateBreadcrumb(path);
                    
                    statusMessage.textContent = `已加载 ${currentFileList.length} 个文件`;
                } catch (error) {
                    console.error('加载文件列表失败:', error);
                    statusMessage.textContent = "加载文件列表失败: " + error.message;
                }
            }
            
            function renderFileList(files) {
                fileList.innerHTML = '';
                
                if (files.length === 0) {
                    fileList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">当前目录为空</div>';
                    return;
                }
                
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.path = file.path;
                    
                    const isVideo = isVideoFile(file.server_filename);
                    const isSubtitle = isSubtitleFile(file.server_filename);
                    
                    fileItem.innerHTML = `
                        <div class="file-icon">
                            <i class="fas ${getFileIcon(file.isdir, file.server_filename)}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.server_filename}</div>
                            <div class="file-size">${file.isdir ? '文件夹' : formatFileSize(file.size)}</div>
                        </div>
                        <div class="file-actions">
                            ${file.isdir ? 
                                `<button class="file-action-btn" onclick="openFolder('${file.path}')">
                                    <i class="fas fa-folder-open"></i> 打开
                                </button>` :
                                `${isVideo ? 
                                    `<button class="file-action-btn" onclick="selectVideoFile('${file.path}', '${file.server_filename}')">
                                        <i class="fas fa-video"></i> 选择视频
                                    </button>` : ''}
                                    ${isSubtitle ? 
                                        `<button class="file-action-btn" onclick="selectSubtitleFile('${file.path}', '${file.server_filename}')">
                                            <i class="fas fa-closed-captioning"></i> 选择字幕
                                        </button>` : ''}
                                    <button class="file-action-btn" onclick="downloadFile('${file.path}')">
                                        <i class="fas fa-download"></i> 下载
                                    </button>`
                            }
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
            }
            
            function getFileIcon(isDir, filename) {
                if (isDir) return 'fa-folder';
                
                const ext = filename.split('.').pop().toLowerCase();
                if (isVideoFile(filename)) return 'fa-video';
                if (isSubtitleFile(filename)) return 'fa-closed-captioning';
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'fa-image';
                if (['mp3', 'wav', 'flac', 'aac'].includes(ext)) return 'fa-music';
                if (['pdf'].includes(ext)) return 'fa-file-pdf';
                if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
                if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
                if (['ppt', 'pptx'].includes(ext)) return 'fa-file-powerpoint';
                if (['zip', 'rar', '7z'].includes(ext)) return 'fa-file-archive';
                return 'fa-file';
            }
            
            function isVideoFile(filename) {
                const videoExts = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'm4v', '3gp', 'mkv'];
                const ext = filename.split('.').pop().toLowerCase();
                return videoExts.includes(ext);
            }
            
            function isSubtitleFile(filename) {
                const subtitleExts = ['srt', 'vtt', 'ass', 'ssa', 'sub', 'txt'];
                const ext = filename.split('.').pop().toLowerCase();
                return subtitleExts.includes(ext);
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function updateBreadcrumb(path) {
                const paths = path.split('/').filter(p => p);
                breadcrumb.innerHTML = '<span class="breadcrumb-item" data-path="/">根目录</span>';
                
                let currentPath = '';
                paths.forEach((folder, index) => {
                    currentPath += '/' + folder;
                    breadcrumb.innerHTML += `
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item" data-path="${currentPath}">${folder}</span>
                    `;
                });
                
                // 添加面包屑点击事件
                breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
                    item.addEventListener('click', () => {
                        loadFileList(item.dataset.path);
                    });
                });
            }
            
            async function selectVideoFile(path, filename) {
                try {
                    statusMessage.innerHTML = '<span class="loading"></span> 正在获取视频文件...';
                    
                    const downloadData = await baiduPanAPI.getFileDownloadUrl(path);
                    const videoUrl = downloadData.dlink;
                    
                    selectedVideoFile = { path, filename, url: videoUrl };
                    videoFilename.textContent = filename;
                    
                    // 加载视频
                    videoPlayer.src = videoUrl;
                    videoPlayer.load();
                    
                    statusMessage.textContent = `已选择视频文件: ${filename}`;
                    previewContainer.style.display = 'block';
                    
                    // 尝试自动播放
                    videoPlayer.play().then(() => {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        statusMessage.textContent = `视频播放中: ${filename}`;
                    }).catch(error => {
                        console.error('自动播放失败:', error);
                        statusMessage.textContent = `视频已加载: ${filename}，点击播放按钮开始播放`;
                    });
                    
                } catch (error) {
                    console.error('选择视频文件失败:', error);
                    statusMessage.textContent = "选择视频文件失败: " + error.message;
                }
            }
            
            async function selectSubtitleFile(path, filename) {
                try {
                    statusMessage.innerHTML = '<span class="loading"></span> 正在获取字幕文件...';
                    
                    const downloadData = await baiduPanAPI.getFileDownloadUrl(path);
                    const subtitleUrl = downloadData.dlink;
                    
                    selectedSubtitleFile = { path, filename, url: subtitleUrl };
                    subtitleFilename.textContent = filename;
                    
                    // 下载并解析字幕文件
                    const response = await fetch(subtitleUrl);
                    if (!response.ok) {
                        throw new Error('下载字幕文件失败');
                    }
                    
                    const content = await response.text();
                    subtitles = parseSubtitle(content);
                    currentSubIndex = 0;
                    loopCount = 0;
                    loopCounter.textContent = `循环: ${loopCount}`;
                    
                    if (subtitles.length > 0) {
                        statusMessage.textContent = `已选择字幕文件: ${filename} (${subtitles.length} 条字幕)`;
                        updateSubtitles();
                        previewContainer.style.display = 'block';
                    } else {
                        statusMessage.textContent = "字幕文件为空或格式不正确";
                    }
                    
                } catch (error) {
                    console.error('选择字幕文件失败:', error);
                    statusMessage.textContent = "选择字幕文件失败: " + error.message;
                }
            }
            
            async function downloadFile(path) {
                try {
                    const downloadData = await baiduPanAPI.getFileDownloadUrl(path);
                    const downloadUrl = downloadData.dlink;
                    
                    // 创建下载链接
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = '';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    statusMessage.textContent = "开始下载文件";
                } catch (error) {
                    console.error('下载文件失败:', error);
                    statusMessage.textContent = "下载文件失败: " + error.message;
                }
            }
            
            function openFolder(path) {
                loadFileList(path);
            }
            
            async function searchFiles() {
                const keyword = fileSearch.value.trim();
                if (!keyword) {
                    loadFileList(currentPath);
                    return;
                }
                
                try {
                    statusMessage.innerHTML = '<span class="loading"></span> 正在搜索文件...';
                    const searchResult = await baiduPanAPI.searchFiles(keyword, currentPath);
                    currentFileList = searchResult.list || [];
                    renderFileList(currentFileList);
                    statusMessage.textContent = `搜索到 ${currentFileList.length} 个文件`;
                } catch (error) {
                    console.error('搜索文件失败:', error);
                    statusMessage.textContent = "搜索文件失败: " + error.message;
                }
            }
            
            // 调用初始化函数
            initializePage();
            
            // 播放/暂停按钮事件
            playPauseBtn.addEventListener('click', function() {
                if (videoPlayer.paused) {
                    // 检查是否有视频源
                    if (!videoPlayer.src && !videoPlayer.currentSrc) {
                        statusMessage.textContent = "请先上传视频文件";
                        return;
                    }
                    
                    videoPlayer.play().then(() => {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        playPauseBtn.classList.add('btn-active');
                        statusMessage.textContent = "播放中";
                    }).catch(error => {
                        console.error('播放失败:', error);
                        statusMessage.textContent = "播放失败，请检查视频文件";
                    });
                } else {
                    videoPlayer.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    statusMessage.textContent = "已暂停";
                }
            });
            
            // 上一句按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentSubIndex > 0) {
                    currentSubIndex--;
                    jumpToSubtitle(currentSubIndex);
                    prevBtn.classList.add('btn-active');
                    setTimeout(() => prevBtn.classList.remove('btn-active'), 300);
                }
            });
            
            // 下一句按钮事件
            nextBtn.addEventListener('click', function() {
                if (currentSubIndex < subtitles.length - 1) {
                    currentSubIndex++;
                    jumpToSubtitle(currentSubIndex);
                    nextBtn.classList.add('btn-active');
                    setTimeout(() => nextBtn.classList.remove('btn-active'), 300);
                }
            });
            
            // 单句循环按钮事件
            loopBtn.addEventListener('click', function() {
                isLooping = !isLooping;
                loopBtn.classList.toggle('active', isLooping);
                
                if (isLooping) {
                    // 设置当前句子的循环起始点
                    if (subtitles.length > 0 && currentSubIndex < subtitles.length) {
                        currentLoopStart = subtitles[currentSubIndex].start;
                        currentLoopEnd = subtitles[currentSubIndex].end;
                    }
                    
                    loopBtn.classList.add('btn-active');
                    setTimeout(() => loopBtn.classList.remove('btn-active'), 300);
                    statusMessage.textContent = "单句循环已启用";
                } else {
                    statusMessage.textContent = "单句循环已禁用";
                }
            });
            
            // 字幕模式选择按钮事件
            subtitleBtn.addEventListener('click', function() {
                subtitleModePopup.classList.add('show');
                statusMessage.textContent = "请选择字幕显示模式";
            });
            
            // 倍速按钮事件
            speedBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const speed = parseFloat(this.dataset.speed);
                    videoPlayer.playbackRate = speed;
                    
                    speedBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    statusMessage.textContent = `播放速度: ${speed}x`;
                });
            });
            
            // 移动端调速按钮事件
            if (mobileSpeedBtn) {
                mobileSpeedBtn.addEventListener('click', function() {
                    speedPopup.classList.add('show');
                    statusMessage.textContent = "请选择播放速度";
                });
            }
            
            // 调速弹窗关闭按钮事件
            if (speedPopupClose) {
                speedPopupClose.addEventListener('click', function() {
                    speedPopup.classList.remove('show');
                });
            }
            
            // 调速弹窗按钮事件
            speedPopupBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const speed = parseFloat(this.dataset.speed);
                    videoPlayer.playbackRate = speed;
                    
                    // 更新所有调速按钮状态
                    speedBtns.forEach(b => b.classList.remove('active'));
                    speedPopupBtns.forEach(b => b.classList.remove('active'));
                    
                    // 激活当前选中的按钮
                    this.classList.add('active');
                    
                    // 找到对应的桌面端按钮并激活
                    const desktopBtn = document.querySelector(`.speed-btn[data-speed="${speed}"]`);
                    if (desktopBtn) {
                        desktopBtn.classList.add('active');
                    }
                    
                    // 关闭弹窗
                    speedPopup.classList.remove('show');
                    
                    statusMessage.textContent = `播放速度: ${speed}x`;
                });
            });
            
            // 字幕模式选择弹窗关闭按钮事件
            if (subtitleModePopupClose) {
                subtitleModePopupClose.addEventListener('click', function() {
                    subtitleModePopup.classList.remove('show');
                });
            }
            
            // 字幕模式选择按钮事件
            subtitleModeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    subtitleMode = mode;
                    
                    // 更新按钮状态
                    subtitleModeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新显示文本
                    const modeTexts = {
                        'both': '中英双语',
                        'english': '仅英文',
                        'chinese': '仅中文',
                        'none': '无字幕'
                    };
                    subtitleModeText.textContent = modeTexts[mode];
                    
                    // 更新字幕显示
                    updateSubtitleDisplay();
                    
                    // 关闭弹窗
                    subtitleModePopup.classList.remove('show');
                    
                    statusMessage.textContent = `字幕模式: ${modeTexts[mode]}`;
                });
            });
            
            // 点击弹窗外部关闭
            document.addEventListener('click', function(e) {
                if (speedPopup && !speedPopup.contains(e.target) && !mobileSpeedBtn.contains(e.target)) {
                    speedPopup.classList.remove('show');
                }
                if (subtitleModePopup && !subtitleModePopup.contains(e.target) && !subtitleBtn.contains(e.target)) {
                    subtitleModePopup.classList.remove('show');
                }
            });
            
            // 视频时间更新事件
            videoPlayer.addEventListener('timeupdate', function() {
                const currentTime = videoPlayer.currentTime;
                const duration = videoPlayer.duration;
                
                // 更新进度条
                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                }
                
                // 检查是否应该循环当前句子
                if (isLooping && subtitles.length > 0) {
                    // 如果当前时间超过当前循环句子的结束时间，则跳回开始
                    if (currentTime >= currentLoopEnd) {
                        loopCount++;
                        loopCounter.textContent = `循环: ${loopCount}`;
                        videoPlayer.currentTime = currentLoopStart;
                        statusMessage.textContent = `当前句子循环次数: ${loopCount}`;
                        return; // 避免执行后续的下一句检测
                    }
                }
                
                // 检查是否应该显示下一句字幕
                if (subtitles.length > 0 && currentSubIndex < subtitles.length - 1 && currentTime >= subtitles[currentSubIndex + 1].start) {
                    currentSubIndex++;
                    updateSubtitles();
                    
                    // 如果开启了循环，更新循环范围
                    if (isLooping) {
                        currentLoopStart = subtitles[currentSubIndex].start;
                        currentLoopEnd = subtitles[currentSubIndex].end;
                    }
                }
            });
            
            // 视频结束事件
            videoPlayer.addEventListener('ended', function() {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                statusMessage.textContent = "播放完成";
            });
            

            
            // 使用说明按钮事件
            helpBtn.addEventListener('click', function() {
                // 在新窗口中打开README.html
                window.open('README.html', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
                statusMessage.textContent = "使用说明已在新窗口中打开";
            });
            
            // 百度网盘登录按钮事件
            loginBtn.addEventListener('click', function() {
                const authUrl = baiduPanAPI.generateAuthUrl();
                window.open(authUrl, 'baidu_auth', 'width=600,height=700,scrollbars=yes,resizable=yes');
                statusMessage.textContent = "正在打开百度网盘授权页面...";
            });
            
            // 百度网盘退出登录按钮事件
            logoutBtn.addEventListener('click', function() {
                baiduPanAPI.logout();
                showLogoutSection();
                selectedVideoFile = null;
                selectedSubtitleFile = null;
                videoFilename.textContent = "未选择视频文件";
                subtitleFilename.textContent = "未选择字幕文件";
                previewContainer.style.display = 'none';
                statusMessage.textContent = "已退出百度网盘登录";
            });
            
            // 文件搜索按钮事件
            searchBtn.addEventListener('click', searchFiles);
            
            // 文件搜索输入框回车事件
            fileSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchFiles();
                }
            });
            
            // 检查URL参数，处理OAuth回调
            function checkAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');
                
                if (error) {
                    statusMessage.textContent = `授权失败: ${error}`;
                    return;
                }
                
                if (code && state) {
                    statusMessage.innerHTML = '<span class="loading"></span> 正在处理授权...';
                    
                    baiduPanAPI.handleAuthCallback(code, state)
                        .then(() => {
                            showLoginSection();
                            loadUserInfo();
                            loadFileList();
                            statusMessage.textContent = "百度网盘登录成功！";
                            
                            // 清除URL参数
                            window.history.replaceState({}, document.title, window.location.pathname);
                        })
                        .catch(error => {
                            console.error('授权处理失败:', error);
                            statusMessage.textContent = "授权处理失败: " + error.message;
                        });
                }
            }
            
                        // 页面加载时检查授权回调
            checkAuthCallback();
            
            // 辅助函数：跳转到指定字幕
            function jumpToSubtitle(index) {
                if (subtitles.length === 0) return;
                
                currentSubIndex = index;
                videoPlayer.currentTime = subtitles[index].start;
                loopCount = 0;
                loopCounter.textContent = `循环: ${loopCount}`;
                updateSubtitles();
                
                // 更新循环范围
                if (isLooping) {
                    currentLoopStart = subtitles[index].start;
                    currentLoopEnd = subtitles[index].end;
                }
                
                if (videoPlayer.paused) {
                    videoPlayer.play().then(() => {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    }).catch(error => {
                        console.error('跳转播放失败:', error);
                    });
                }
            }
            
            // 辅助函数：解析字幕文件
            function parseSubtitle(text) {
                console.log('开始解析字幕文件，内容长度:', text.length);
                
                const subtitles = [];
                const blocks = text.split(/\n\s*\n/);
                
                console.log('分割后的块数量:', blocks.length);
                
                for (let i = 0; i < blocks.length; i++) {
                    const block = blocks[i];
                    if (!block.trim()) continue;
                    
                    const lines = block.split('\n').map(line => line.trim()).filter(line => line !== '');
                    
                    console.log(`块 ${i + 1} 行数:`, lines.length, '内容:', lines);
                    
                    // 至少需要序号、时间轴和内容
                    if (lines.length < 3) {
                        console.log(`块 ${i + 1} 行数不足，跳过`);
                        continue;
                    }
                    
                    // 解析时间轴
                    const timeline = lines[1];
                    const timeParts = timeline.split('-->');
                    if (timeParts.length !== 2) {
                        console.log(`块 ${i + 1} 时间轴格式错误:`, timeline);
                        continue;
                    }
                    
                    const startTime = parseTime(timeParts[0].trim());
                    const endTime = parseTime(timeParts[1].trim());
                    
                    console.log(`块 ${i + 1} 时间:`, startTime, '->', endTime);
                    
                    // 内容行 - 取第2行之后的所有行
                    const contentLines = lines.slice(2);
                    
                    // 尝试分离中英文字幕
                    let eng = "";
                    let chi = "";
                    
                    // 策略1：一行中文一行英文（根据实际字幕文件格式）
                    if (contentLines.length >= 2) {
                        // 第一行是中文，第二行是英文
                        chi = contentLines[0];
                        eng = contentLines[1];
                        console.log(`块 ${i + 1} 分离结果 - 中文:`, chi, '英文:', eng);
                    } 
                    // 策略2：单行内容，尝试用括号分隔
                    else if (contentLines.length === 1) {
                        const content = contentLines[0];
                        // 尝试匹配中括号或小括号中的中文内容
                        const match = content.match(/(.*?)[（(](.+?)[)）](.*)/);
                        if (match) {
                            eng = (match[1] + match[3]).trim();
                            chi = match[2].trim();
                            console.log(`块 ${i + 1} 括号分离结果 - 英文:`, eng, '中文:', chi);
                        } else {
                            // 策略3：尝试用斜杠分隔
                            const slashMatch = content.match(/(.*?)\/(.*)/);
                            if (slashMatch) {
                                chi = slashMatch[1].trim();
                                eng = slashMatch[2].trim();
                                console.log(`块 ${i + 1} 斜杠分离结果 - 中文:`, chi, '英文:', eng);
                            } else {
                                // 策略4：尝试用破折号分隔
                                const dashMatch = content.match(/(.*?)\s*-\s*(.*)/);
                                if (dashMatch) {
                                    chi = dashMatch[1].trim();
                                    eng = dashMatch[2].trim();
                                    console.log(`块 ${i + 1} 破折号分离结果 - 中文:`, chi, '英文:', eng);
                                } else {
                                    // 无法分离，整行作为英文
                                    eng = content;
                                    chi = content;
                                    console.log(`块 ${i + 1} 无法分离，使用原内容:`, content);
                                }
                            }
                        }
                    }
                    
                    subtitles.push({
                        start: startTime,
                        end: endTime,
                        eng: eng,
                        chi: chi
                    });
                }
                
                console.log('解析完成，总字幕数:', subtitles.length);
                return subtitles;
            }
            
            // 辅助函数：转换时间格式
            function parseTime(timeStr) {
                // 支持两种格式：00:00:05,000 和 00:00:05.000
                const parts = timeStr.split(/[:,.]/);
                if (parts.length !== 4) return 0;
                
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                const seconds = parseInt(parts[2]);
                const milliseconds = parseInt(parts[3]);
                
                return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
            }
            
            // 更新字幕显示
            function updateSubtitles() {
                if (subtitles.length === 0) {
                    englishSub.innerHTML = "";
                    chineseSub.textContent = "";
                    return;
                }
                
                const currentSub = subtitles[currentSubIndex];
                
                // 使用拆分单词的方式渲染英文句子
                englishSub.innerHTML = renderEnglishSentence(currentSub.eng);
                chineseSub.textContent = currentSub.chi;
                
                // 根据字幕模式更新显示
                updateSubtitleDisplay();
            }
            
            // 根据字幕模式更新字幕显示
            function updateSubtitleDisplay() {
                if (subtitles.length === 0) {
                    englishSub.innerHTML = "";
                    chineseSub.textContent = "";
                    return;
                }
                
                const currentSub = subtitles[currentSubIndex];
                
                // 根据模式显示字幕
                switch (subtitleMode) {
                    case 'both':
                        // 中英双语
                        englishSub.innerHTML = renderEnglishSentence(currentSub.eng);
                        chineseSub.textContent = currentSub.chi;
                        englishSub.style.display = 'block';
                        chineseSub.style.display = 'block';
                        englishSub.style.order = '1 !important';
                        chineseSub.style.order = '2 !important';
                        break;
                    case 'english':
                        // 仅英文
                        englishSub.innerHTML = renderEnglishSentence(currentSub.eng);
                        chineseSub.textContent = '';
                        englishSub.style.display = 'block';
                        chineseSub.style.display = 'none';
                        englishSub.style.order = '1 !important';
                        break;
                    case 'chinese':
                        // 仅中文
                        englishSub.innerHTML = '';
                        chineseSub.textContent = currentSub.chi;
                        englishSub.style.display = 'none';
                        chineseSub.style.display = 'block';
                        chineseSub.style.order = '1 !important';
                        break;
                    case 'none':
                        // 无字幕
                        englishSub.innerHTML = '';
                        chineseSub.textContent = '';
                        englishSub.style.display = 'none';
                        chineseSub.style.display = 'none';
                        break;
                }
                
                // 添加字幕动画
                if (subtitleMode !== 'none') {
                    const visibleElements = [];
                    if (englishSub.style.display !== 'none') visibleElements.push(englishSub);
                    if (chineseSub.style.display !== 'none') visibleElements.push(chineseSub);
                    
                    visibleElements.forEach(element => {
                        element.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 300);
                    });
                }
            }
        });
    </script>
</body>
</html>